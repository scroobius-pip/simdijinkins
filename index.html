<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Tau-Prolog Data Server Site</title>
        <style>
            body {
                font-family: monospace;
                background: #000;
                color: #0f0;
                margin: 0;
                padding: 10px;
            }
            #teletype {
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            #query-input {
                background: transparent;
                border: none;
                color: #0f0;
                font-family: monospace;
                width: 100%;
                outline: none;
            }
            #editor-container {
                display: none;
                margin: 10px;
                background: #111;
                padding: 10px;
                border: 1px solid #0f0;
            }
            #editor-textarea {
                width: 100%;
                height: 400px;
                background: #000;
                color: #0f0;
                border: none;
                font-family: monospace;
            }
        </style>
    </head>
    <body>
        <div id="teletype"></div>
        <input id="query-input" placeholder="?- " autocomplete="off" />

        <script type="text/javascript" src="tau-prolog.js"></script>

        <script>
            // Core Logic
            var pl; // Tau Prolog namespace
            var session = pl.create(); // Create Prolog session

            var prologCode = `
            % Ontology facts (pure data and logic)
            triple('post1', type, 'blogPost').
            triple('post1', title, 'My First Post').
            triple('post1', content, 'Hello, world!').
            triple('post1', image_url, 'https://example.com/image.jpg').

            is_blog_post(X) :- triple(X, type, 'blogPost').
        `;

            // Load initial code
            session.consult(prologCode, {
                success: function () {
                    console.log("Ontology loaded");
                },
                error: function (err) {
                    console.error("Load error:", err);
                },
            });

            // Teletype UI Management (all in JS)
            const teletype = document.getElementById("teletype");
            const input = document.getElementById("query-input");

            // Function to append to teletype
            function appendToTeletype(text) {
                teletype.innerHTML += text + "<br>";
                teletype.scrollTop = teletype.scrollHeight;
            }

            // Query Function - Prolog serves data, JS renders
            function runQuery(goal) {
                session.query(goal, {
                    success: function () {
                        collectAnswers([]);
                    },
                    error: function (err) {
                        appendToTeletype("Error: " + err);
                    },
                });
            }

            function collectAnswers(answers) {
                session.answer({
                    success: function (answer) {
                        answers.push(session.format_answer(answer));
                        collectAnswers(answers); // Get next
                    },
                    fail: function () {
                        appendToTeletype(answers.join("; ") || "false.");
                    },
                    error: function (err) {
                        appendToTeletype("Exception: " + err);
                    },
                    limit: function () {
                        appendToTeletype("Limit reached.");
                    },
                });
            }

            // Improved Query Parsing
            function parseGoal(input) {
                let goal = input.trim();
                if (goal.startsWith("?-")) goal = goal.slice(2).trim();
                if (!goal.endsWith(".")) goal += ".";
                return goal;
            }

            // Handle Input (teletype style)
            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    const userInput = input.value;
                    appendToTeletype("?- " + userInput + ".");
                    const goal = parseGoal(userInput);
                    runQuery(goal);
                    input.value = "";
                }
            });

            // Self-Editing: Triggered purely in JS (Ctrl+E)
            document.addEventListener("keydown", function (e) {
                if (e.ctrlKey && e.key === "e") {
                    openEditor();
                }
            });

            function openEditor() {
                let container = document.getElementById("editor-container");
                if (!container) {
                    container = document.createElement("div");
                    container.id = "editor-container";
                    document.body.appendChild(container);
                }
                container.style.display = "block";

                const textarea = document.createElement("textarea");
                textarea.id = "editor-textarea";
                textarea.value = prologCode;
                container.appendChild(textarea);

                const saveBtn = document.createElement("button");
                saveBtn.textContent = "Save & Reload";
                saveBtn.style.background = "#0f0";
                color = "#000";
                saveBtn.onclick = function () {
                    prologCode = textarea.value;
                    session.consult(prologCode, {
                        success: function () {
                            appendToTeletype("Ontology updated.");
                            downloadUpdatedFile();
                        },
                        error: function (err) {
                            appendToTeletype("Update error: " + err);
                        },
                    });
                    container.style.display = "none";
                };
                container.appendChild(saveBtn);
            }

            // Download updated HTML
            function downloadUpdatedFile() {
                const updatedHTML = document.documentElement.outerHTML.replace(
                    /var prologCode = `[\s\S]*?`;/,
                    "var prologCode = `" +
                        prologCode.replace(/`/g, "\\`") +
                        "`;",
                );
                const blob = new Blob([updatedHTML], { type: "text/html" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "personal-site-tau-updated.html";
                a.click();
            }

            // Initial Teletype Greeting (ephemeral UI starts minimal)
            appendToTeletype("Teletype ready. Enter Prolog queries.");
        </script>
    </body>
</html>
